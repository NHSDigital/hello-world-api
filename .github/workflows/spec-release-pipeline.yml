name: spec-release-pipeline
on:
  push
permissions: read-all

jobs:
  deploy-hello-world-spec:
    runs-on: ubuntu-latest
    env:
      proxygen_private_key: ${{ secrets.ENCODED_HELLO_WORLD_PROXYGEN_PRIVATE_KEY }}
      proxygen_client_id: ${{ secrets.HELLO_WORLD_PROXYGEN_CLIENT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Get Pull Request Number
        id: pr
        if: github.ref != 'refs/heads/master'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_number=$(gh pr view --json number -q .number || echo "")
          if test -z "$pr_number"
          then
                echo "Pipeline can't be run on branch other than master without PR number"
                exit 1
          else
                echo PR number - $pr_number
          fi

      - name: Install Python 3.8
        uses: actions/setup-python@v1
        with:
          python-version: 3.8

      - name: Update apt repositories
        run: sudo apt update

      - name: Install Node
        run: sudo apt-get install --yes nodejs

      - name: Install poetry
        run: pip install poetry

      - name: Cache poetry packages
        uses: actions/cache@v1
        with:
          path: ~/.cache/pypoetry
          key: ${{ runner.os }}-build-cache-poetry-packages-${{ hashFiles('**/poetry.lock') }}

      - name: Cache node modules
        uses: actions/cache@v1
        with:
          path: ~/.npm
          key: ${{ runner.os }}-build-cache-npm-packages-${{ hashFiles('**/package-lock.json') }}

      - name: Install python dependencies
        run: poetry install

      - name: Install Node dependencies
        run: npm install --legacy-peer-deps

      - name: Install Proxygen client
        run: curl -o- https://raw.githubusercontent.com/NHSDigital/proxygen-cli/main/install.sh | bash

      - name: Lint spec
        run: make lint-spec

      - name: Compile spec
        if: github.ref == 'refs/heads/master'
        run: |
            export TITLE="Hello World API"
            export ENVIRONMENT="sandbox"
            export INSTANCE="hello-world"
            source scripts/compile-spec.sh

      - name: Deploy spec
        if: github.ref == 'refs/heads/master'
        run: |
          # Authenticate with Proxygen #
          echo -n $proxygen_private_key | base64 --decode > proxygen_private_key.key
          proxygen setup-machine-user --client-id=$proxygen_client_id --private-key=proxygen_private_key.key

          curl -X PUT https://proxygen.ptl.api.platform.nhs.uk/apis/hello-world/spec \
          -H "Authorization: $(proxygen get-token)" \
          -H 'Content-Type: application/json' \
          -d @build/hello-world-rendered.json \
          --fail
